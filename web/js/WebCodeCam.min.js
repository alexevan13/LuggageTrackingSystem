/*!
 * jQuery Plugin WebCodeCam-1.0.0
 * Author: Tóth András
 * Web: http://atandrastoth.co.uk
 * email: atandrastoth@gmail.com
 * Licensed under the MIT license
 */

/*
Included:
barcode decoder (DecoderWorker.js) -> https://github.com/EddieLa/BarcodeReader/blob/master/src/DecoderWorker.js
qr-decoder (qrcodelib.js) -> https://github.com/LazarSoft/jsqrcode
*/
;
(function(n,C,H,I){function D(b,a){this.element=b;t=n(b);this.options=n.extend({},E,a);this._defaults=E;this._name="WebCodeCam";this.init()&&(this.setEventListeners(),(this.options.ReadQRCode||this.options.ReadBarecode)&&this.setCallback())}var a,u,k,t,h,g,l={},e=n('<video style="position:absolute;visibility:hidden;display: none;">')[0],v=!1,F=!1,G=new Worker("js/DecoderWorker.js"),m=!1,E={ReadQRCode:!0,ReadBarecode:!0,width:320,height:240,videoSource:{id:!0,maxWidth:640,maxHeight:480},flipVertical:!1,
flipHorizontal:!1,zoom:-1,beep:"js/beep.mp3",brightness:0,autoBrightnessValue:!1,grayScale:!1,contrast:0,threshold:0,sharpness:[],resultFunction:function(b,a){},getUserMediaError:function(){},cameraError:function(b){}};D.prototype={init:function(){a=this;k=a.element.getContext("2d");h=a.options.width;g=a.options.height;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia)l[a.options.videoSource.id]&&
l[a.options.videoSource.id].active?a.cameraSuccess(l[a.options.videoSource.id]):navigator.getUserMedia({video:{mandatory:{maxWidth:a.options.videoSource.maxWidth,maxHeight:a.options.videoSource.maxHeight},optional:[{sourceId:a.options.videoSource.id}]},audio:!1},a.cameraSuccess,a.cameraError);else return a.options.getUserMediaError(),!1;return!0},cameraSuccess:function(b){l[a.options.videoSource.id]=b;var p=C.URL||C.webkitURL;e.src=p?p.createObjectURL(b):b;e.play()},cameraError:function(b){a.options.cameraError(b);
return!1},setEventListeners:function(){e.addEventListener("canplay",function(b){F||(0<e.videoWidth&&(g=e.videoHeight/(e.videoWidth/h)),t[0].setAttribute("width",h),t[0].setAttribute("height",g),a.options.flipHorizontal&&(k.scale(-1,1),k.translate(-h,0)),a.options.flipVertical&&(k.scale(1,-1),k.translate(0,-g)),F=!0,(a.options.ReadQRCode||a.options.ReadBarecode)&&a.delay())},!1);e.addEventListener("play",function(){setInterval(function(){if(!e.paused&&!e.ended){k.clearRect(0,0,h,g);var b=a.options.zoom;
0>b&&(b=a.optimalZoom());k.drawImage(e,(h*b-h)/-2,(g*b-g)/-2,h*b,g*b);b=k.getImageData(0,0,h,g);a.options.grayScale&&(b=a.grayScale(b));if(0!=a.options.brightness||0!=a.options.autoBrightnessValue)b=a.brightness(b,a.options.brightness);0!=a.options.contrast&&(b=a.contrast(b,a.options.contrast));0!=a.options.threshold&&(b=a.threshold(b,a.options.threshold));0!=a.options.sharpness.length&&(b=a.convolute(b,a.options.sharpness));k.putImageData(b,0,0)}},40)},!1)},setCallback:function(){G.onmessage=function(b){m||
e.paused||(b.data.success&&1<b.data.result[0].length&&-1==b.data.result[0].indexOf("undefined")?(a.beep(),m=!0,a.delay(),a.options.resultFunction(b.data.result[0],u)):b.data.finished&&(v=!v,setTimeout(function(){a.tryParseBarecode()},320)))};qrcode.callback=function(b){m||e.paused||(a.beep(),m=!0,a.delay(),a.options.resultFunction(b,u))}},tryParseBarecode:function(){var b=1==v?"flip":"normal";u=t[0].toDataURL();var a=k.getImageData(0,0,h,g).data;G.postMessage({ImageData:a,Width:h,Height:g,cmd:b,DecodeNr:1,
LowLight:!1})},tryParseQRCode:function(){try{u=t[0].toDataURL(),qrcode.decode()}catch(b){m||setTimeout(function(){a.tryParseQRCode()},320)}},delay:function(){a.cameraPlay(!0)},cameraStop:function(){m=!0;e.pause()},cameraStopAll:function(){k.clearRect(0,0,h,g);m=!0;e.pause();for(var b in l)l[b]&&(l[b].stop(),l[b]=null)},cameraPlay:function(b){l[a.options.videoSource.id]?b||a.cameraSuccess(l[a.options.videoSource.id]):a.init();m=!0;e.play();setTimeout(function(){m=!1;a.options.ReadBarecode&&a.tryParseBarecode();
a.options.ReadQRCode&&a.tryParseQRCode()},2E3)},getLastImageSrc:function(){return u},optimalZoom:function(b){return e.videoHeight/g},getImageLightness:function(){for(var b=k.getImageData(0,0,h,g).data,a=0,d,c,f,e=0,l=b.length;e<l;e+=4)d=b[e],c=b[e+1],f=b[e+2],d=Math.floor((d+c+f)/3),a+=d;return Math.floor(a/(h*g))},brightness:function(b,p){p=0==p&&0!=a.options.autoBrightnessValue?a.options.autoBrightnessValue-a.getImageLightness():p;for(var d=b.data,c=0;c<d.length;c+=4)d[c]+=p,d[c+1]+=p,d[c+2]+=p;
return b},grayScale:function(b){for(var a=b.data,d=0;d<a.length;d+=4)a[d]=a[d+1]=a[d+2]=.2126*a[d]+.7152*a[d+1]+.0722*a[d+2];return b},contrast:function(b,a){for(var d=b.data,c=0;c<d.length;c+=4){a=10;var f=Math.round((d[c]+d[c+1]+d[c+2])/3);127<f?(d[c]+=d[c]/f*a,d[c+1]+=d[c+1]/f*a,d[c+2]+=d[c+2]/f*a):(d[c]-=d[c]/f*a,d[c+1]-=d[c+1]/f*a,d[c+2]-=d[c+2]/f*a)}return b},threshold:function(a,e){for(var d,c=a.data,f=0,k=h*g*4;f<k;f+=4)d=c[f]+c[f+1]+c[f+2],c[f]=d<e?c[f+1]=c[f+2]=0:c[f+1]=c[f+2]=255,c[f+3]=
255;return a},convolute:function(a,e,d){var c=a.width,f=a.height,g=Math.round(Math.sqrt(e.length)),h=Math.floor(g/2);a=a.data;var k=H.createElement("canvas").getContext("2d").createImageData(c,f),l=k.data;d=d?1:0;for(var m=0;m<f;m++)for(var n=0;n<c;n++){for(var t=m,u=n,v=0,A=0,B=0,w=0,x=4*(m*c+n),y=0;y<g;y++)for(var z=0;z<g;z++){var q=t+y-h,r=u+z-h;0<=q&&q<f&&0<=r&&r<c&&(q=4*(q*c+r),r=e[y*g+z],v+=a[q]*r,A+=a[q+1]*r,B+=a[q+2]*r,w+=a[q+3]*r)}l[x]=v;l[x+1]=A;l[x+2]=B;l[x+3]=w+d*(255-w)}return k},beep:function(){if("string"==
typeof a.options.beep){var b=a.options.beep;setTimeout(function(){(new Audio(b)).play()},0)}}};n.fn.WebCodeCam=function(a){return this.each(function(){n.data(this,"plugin_WebCodeCam")||n.data(this,"plugin_WebCodeCam",new D(this,a))})}})(jQuery,window,document);